@using System.Reflection;
@using Newtonsoft.Json;
@using SurveyJsBlazor.Models;

@implements IAsyncDisposable
@inject IJSRuntime jsRuntime

<HeadContent>
    <link href="/_content/@(assemblyName)/libs/survey-core/defaultv2.min.css" rel="stylesheet" />
    <link href="/_content/@(assemblyName)/libs/survey-creator-core/survey-creator-core.min.css" rel="stylesheet" />
</HeadContent>

<div id="@this.GetHashCode()" @attributes=AllOtherAttributes></div>

@code {
    public SurveyJsCreator()
    {
        Instance = this;
    }

    private static SurveyJsCreator Instance = default!;

    [Parameter]
    public object? Scheme { get; set; }
    
    [Parameter]
    public CreatorOptions? CreatorOptions { get; set; }

    [Parameter]
    public EventCallback<object> SaveSurveyFunc { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AllOtherAttributes { get; set; }

    private readonly string assemblyName = Assembly.GetExecutingAssembly().GetName().Name ?? "";
    private IJSObjectReference? jsModule;
    private DotNetObjectReference<SurveyJsCreator>? objRef;

    protected override void OnInitialized()
    {
        objRef = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsModule = await jsRuntime.InvokeAsync<IJSObjectReference>("import", $"/_content/{assemblyName}/Components/SurveyJsCreator.razor.js");

            string? serializedScheme = this.Scheme is not null ? JsonConvert.SerializeObject(this.Scheme) : null;

            var renderModel = new CreatorJs.Render
            {
                DotNetObject = objRef,
                HashId = this.GetHashCode(),
                CreatorOptions = CreatorOptions,
                JsonScheme = serializedScheme
            };

            await jsModule.InvokeVoidAsync("render", renderModel);
        }
    }

    [JSInvokable]
    public async void SaveSurveyFuncHandle(object data)
    {
        await SaveSurveyFunc.InvokeAsync(data);
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (jsModule is not null)
        {
            await jsModule.DisposeAsync();
        }
        objRef?.Dispose();

        GC.SuppressFinalize(this);
    }
}
